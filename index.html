<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="mobile-web-app-capable" content="yes">
	<title>Magic Smile</title>
 <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
<style type="text/css">
.jobd {
background-color:lightskyblue; width:95%; padding:2px 10px 2px 10px;
}
</style>
	<script src="phonegap.js"></script>
      <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
	<script src="jquery.mobile-1.4.5.min.js"></script>
	<script>


var logOb;
var fileURL='';
var nameFile, fsroot=null;
var juser=0, jobno=0;

document.addEventListener('deviceready', onDeviceReady, false);

function onDeviceReady() {
	window.resolveLocalFileSystemURL(cordova.file.dataDirectory, function(dir) {
          fsroot=dir;
		dir.getFile("log.jpg", {create:true}, function(file) {
			logOb = file;
                fileURL = logOb.toURL();
		});

	});
}

function fail(e) {
alert('fail');
	console.log("FileSystem Error");
	console.dir(e);
}

function errorHandler()
{ alert('error');
}

function jkinit()
{
     var dcode=window.localStorage.getItem('dcode');
     if (!dcode) dcode='';
     if (dcode.length) {
            $("#pan2").show();
     }
          else {
            $("#pan1").show();
     }       
}

function jlogin()
{ url='http://brandonkur.com.au/dcode.php?dcode='+$("#dcode").val();
  $.ajax({url: url, 
    success : function(result) {
      if (result.length) {
         window.localStorage.setItem('dcode',result);
            $("#pan1").hide();
            $("#pan2").show();

      }
      else {
         $("#err").show();
         setTimeout(noshow,2000);
      }
    }
  });
}

function noshow()
{ $("#err").hide();
}

function writeLog(b) {
	if(!logOb) return;
    logOb.createWriter(function(fileWriter) {
fileWriter.onwriteend = function(e) {
        doupload();
      };
		fileWriter.write(b);
	}, fail);
}


function takepic()
{navigator.camera.getPicture(onSuccess, onFail, { quality: 80, targetWidth: 550, targetHeight: 550, 
    destinationType: Camera.DestinationType.DATA_URL
  });
}

function onSuccess(imageData) {
//    var image = document.getElementById('thispic');
//    image.src = "data:image/jpeg;base64," + imageData;
//    var blob = b64toBlob(imageData, 'image/jpeg');
//    alert('sending: '+imageData.length);
    writeLog(imageData);
}

function onFail(message) {
    alert('Failed because: ' + message);
}

var win = function (r) {
          $("#mylist").html(r.response);
         $("#mylist").trigger('create');
 
}

var fail = function (error) {
   alert("An error has occurred: Code = " + error.code);
}

function doupload()
{
 var options = new FileUploadOptions();
 options.fileKey = "file";
 options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
 options.mimeType = "application/base64";
 options.trustAllHosts = true;
 var params = {};
 params.value1 = window.localStorage.getItem('dcode');
 options.params = params;
 var ft = new FileTransfer();
 ft.upload(fileURL, encodeURI("http://brandonkur.com.au/uploadpic.php"), win, fail, options);
}

function jlogout()
{ window.localStorage.clear();
  $("#pan2").hide();
  $("#pan1").show();
}

function clrsearch()
{ $("#lotno").val('');
  $("#cname").val('');
  $("#other").val('');
}


function gojob(a,t)
{ var url='http://treacydata.com/gojob.php?id='+a.toString()+'&typ='+t;
  jobno=a;
  $.ajax({url: url, 
    success : function(result) {
         $("#mylist").html(result);
         $("#mylist").trigger('create');
         jQuery.mobile.changePage("#listpage", {transition: "flip"});
    }
  });
}

</script>
</head>
<body onload="jkinit()">

<div data-role="page" id="intropage" style="background-color:#BAD8FA">

 <div role="main" class="ui-content">
<div name="pan1" id="pan1" style="display:none; background-color:#BAD8FA; background-image:url('back1.jpg'); backgroud-repeat:no-repeat; background-size:cover; height:100%; width:100%">
<div style="padding-left:20px">
<b style="color:dodgerblue">MagicSmile</b>
<br><br>
<p>You won't recognize yourself!</p>
<p><small>Please Enter the Code from your dentist</small></p>
<div class="ui-grid-a">
<div class="ui-block-a">
<label for="dcode">Access Code</label>
<input type="text" name="dcode" id="dcode" size="6" autocorrect="off" autocapitalize="off" autocomplete="off" >
<br><span id="err" style="color:red; display:none">Invalid Code</span>
<br>
<br>

<input type="button" style="background-color:#66ff66" value="LOG IN" onclick="jlogin();">
<br><br>

</div>
<div class="ui-block-b"> &nbsp; </div>
</div>
</div>
</div>
<div name="pan2" id="pan2" style="display:none">
<div id="mylist">
<p>Instructions go here</p>
<p>View example photos and show tips for taking best photo</p>
</div>
<button class="ui-btn ui-icon-camera ui-btn-icon-top" style="background-color:#BBffBB" onclick="takepic();">TAKE PICTURE</button>
<br>
<input type="button" style="background-color:tomato" value="LOG-OUT" onclick="jlogout();">


</div>
</div>
</div>

<div data-role="page" id="listpage" >
<div data-role="header" data-position="fixed">
<div style="float:left" id="custom-border-radius"><a href="#intropage" class="ui-btn ui-icon-back ui-btn-icon-notext ui-corner-all">Back</a></div>
<h3>Treacy Fencing</h3>
 </div>
<div role="main" class="ui-content">

</div>
</div>

</body>
</html>