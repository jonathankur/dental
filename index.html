<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="mobile-web-app-capable" content="yes">
	<title>Magic Smile</title>
 <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
<style type="text/css">
.jobd {
background-color:lightskyblue; width:95%; padding:2px 10px 2px 10px;
}
</style>
	<script src="phonegap.js"></script>
      <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
	<script src="jquery.mobile-1.4.5.min.js"></script>
	<script>


var logOb;
var fileURL='';
var nameFile, fsroot=null;
var juser=0, jobno=0;
var tot;
var imex=0;

document.addEventListener('deviceready', onDeviceReady, false);

function onDeviceReady() {
	window.resolveLocalFileSystemURL(cordova.file.dataDirectory, function(dir) {
          fsroot=dir;
		dir.getFile("log.jpg", {create:true}, function(file) {
			logOb = file;
                fileURL = logOb.toURL();
		});

	});

 var notificationOpenedCallback = function(jsonData) {
    alert('notificationOpenedCallback: ' + JSON.stringify(jsonData));
  };

 var mypush = document.localStorage.getItem('mypush');
 if (!mypush) mypush='';
 alert('['+mypush+']['+mypush.length+']');
 if (!mypush.length) {
  window.plugins.OneSignal
    .startInit("45b78784-af31-424d-8941-addce6905416")
    .handleNotificationOpened(notificationOpenedCallback)
    .endInit();
 }
}

function fail(e) {
alert('fail');
	console.log("FileSystem Error");
	console.dir(e);
}

function errorHandler()
{ alert('error');
}

function jkinit()
{
     var dcode=window.localStorage.getItem('dcode');
     if (!dcode) dcode='';
     if (dcode.length) {
         jQuery.mobile.changePage("#listpage", {transition: "flip"});
     }
     tot = setTimeout(moveim,2000);
}

function moveim()
{ imex = -250 - imex;
  document.getElementById('expic').style.left= imex.toString()+'px';
  tot = setTimeout(moveim,2000);
}  

function showpic(a)
{ document.getElementById('expic').src='zfinal'+a.toString()+'.jpg';
}

function jlogin()
{ url='http://brandonkur.com.au/dcode.php?dcode='+$("#dcode").val();
  $.ajax({url: url, 
    success : function(result) {
      if (result.length) {
         window.localStorage.setItem('dcode',result);
         jQuery.mobile.changePage("#listpage", {transition: "flip"});

      }
      else {
         $("#err").show();
         setTimeout(noshow,2000);
      }
    }
  });
}

function noshow()
{ $("#err").hide();
}

function writeLog(b) {
	if(!logOb) return;
    logOb.createWriter(function(fileWriter) {
fileWriter.onwriteend = function(e) {
        doupload();
      };
		fileWriter.write(b);
	}, fail);
}


function takepic()
{navigator.camera.getPicture(onSuccess, onFail, { quality: 80, targetWidth: 550, targetHeight: 550, 
    correctOrientation: true, cameraDirection : Camera.Direction.FRONT, destinationType: Camera.DestinationType.DATA_URL
  });
}

function onSuccess(imageData) {
    writeLog(imageData);
}

function onFail(message) {
    alert('Failed because: ' + message);
}

var win = function (r) {
          $("#mylist").html(r.response);
         $("#mylist").trigger('create');
 
}

var fail = function (error) {
   alert("An error has occurred: Code = " + error.code);
}

function doupload()
{
 var options = new FileUploadOptions();
 options.fileKey = "file";
 options.fileName = fileURL.substr(fileURL.lastIndexOf('/') + 1);
 options.mimeType = "application/base64";
 options.trustAllHosts = true;
 var params = {};
 params.value1 = window.localStorage.getItem('dcode');
 options.params = params;
 var ft = new FileTransfer();
 ft.upload(fileURL, encodeURI("http://brandonkur.com.au/uploadpic.php"), win, fail, options);
}

function jlogout()
{ window.localStorage.clear();
         jQuery.mobile.changePage("#intropage", {transition: "flip"});
}


function gojob(a,t)
{ var url='http://treacydata.com/gojob.php?id='+a.toString()+'&typ='+t;
  jobno=a;
  $.ajax({url: url, 
    success : function(result) {
         $("#mylist").html(result);
         $("#mylist").trigger('create');
         jQuery.mobile.changePage("#listpage", {transition: "flip"});
    }
  });
}

</script>
</head>
<body onload="jkinit()">

<div data-role="page" id="intropage" style="background-color:#BAD8FA; background-image:URL('intro.jpg'); background-repeat:no-repeat; background-size:cover">

 <div role="main" class="ui-content">
<div style="padding-left:20px">
<b style="color:dodgerblue">MagicSmile</b>
<br><br>
<p>You won't recognize yourself!</p>
<p><small>Please Enter the Code from your dentist</small></p>
<div class="ui-grid-a">
<div class="ui-block-a">
<label for="dcode">Access Code</label>
<input type="text" name="dcode" id="dcode" size="6" autocorrect="off" autocapitalize="off" autocomplete="off" >
<br><span id="err" style="color:red; display:none">Invalid Code</span>
<br>
<br>

<input type="button" style="background-color:#66ff66" value="LOG IN" onclick="jlogin();">
<br><br>

</div>
<div class="ui-block-b"> &nbsp; </div>
</div>
</div>
</div>
</div>

<div data-role="page" id="listpage" style="background-color:#BAD8FA">
<div role="main" class="ui-content">
<center>
<div data-role="controlgroup" data-type="horizontal">
 <a href="#" class="ui-btn ui-corner-all" onclick="showpic(1);"> 1 </a>
 <a href="#" class="ui-btn ui-corner-all" onclick="showpic(2);"> 2 </a>
 <a href="#" class="ui-btn ui-corner-all" onclick="showpic(3);"> 3 </a>
</div>

<div name="picholder" id="picholder" style="width:250px; overflow:hidden; height:375px; min-height:375px; position:relative">
<img id="expic" name="expic" style="position:absolute; left:0px" src="zfinal1.jpg" width="500">
</div>
</center>
</div>
<div data-role="footer" data-position="fixed" style="overflow:hidden; ">
 <div data-role="navbar">
 <ul>
  <li><a href="#" data-icon="camera" onclick="takepic()">Take Picture</a></li>
  <li><a href="#" data-icon="user" onclick="">My Account</a></li>
  <li><a href="#" data-icon="back" onclick="jlogout()">Log-Out</a></li>
 </ul>
</div>
</div>

</body>
</html>